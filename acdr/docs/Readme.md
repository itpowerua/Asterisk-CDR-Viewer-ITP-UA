
## Системні вимоги

- PHP 5.2 і вище
- База даних MySQL або інша, яка підтримується PDO (PostgreSQL...)
- Веб-сервер (Nginx, Apache, Lighttpd...)

## Формати записів розмов

Використовується HTML5 плеєр для відтворення записів розмов. 
Доступні формати аудіо: MP3, WAV, OGG, AAC...

Перевірені формати аудіо. Перевірялося в Internet Explorer 11, Chrome 56, Firefox 52:
- MP3. Підтримуються всі браузери
- WAV. Не працює в Internet Explorer
- OGG. Не працює в Internet Explorer

Формат GSM не підтримується для відтворення жодним браузером.


## Редагування бази даних

З базою даних MySQL найзручніше працювати через PHPMYADMIN. Офіційний сайт: https://www.phpmyadmin.net/

Якщо у вас використовується не база даних MySQL (а, наприклад, PostgreSQL), або PHPMYADMIN не встановлено, то слід використовувати ADMINER. Офіційний сайт: https://www.adminer.org/

## Створення таблиці в базі

Ім'я файлу запису розмови зберігатиметься в базі MySQL (можна також вибрати, наприклад, PostgreSQL).

Для MySQL можна використовувати файл імпорту `mysql_cdr.sql`, його можна знайти в папці docs. Якщо імпортувати цей файл у базу, то в базі буде створено таблицю "cdr" з усіма необхідними для Asterisk полями.

Ім'я колонки для файлу запису дзвінка буде "filename". Також будуть створені необхідні індекси і тригер, про який можна прочитати нижче.

На додаток до всього, файл імпорту створіть нові колонки в базі для Asterisk 12+.

Якщо ім'я таблиці "cdr" (або ім'я колонки для файлу запису дзвінка) не влаштовує, після імпорту самі зможете перейменувати. Наприклад, за допомогою **PHPMYADMIN** або **ADMINER**.


## Налаштування Asterisk

Для того, щоб Asterisk зміг взаємодіяти з новими стовпцями в таблиці, необхідно у файлі `cdr_mysql.conf` створити їхні аліаси.

Додамо в кінець цього файлу ( секція [columns] ) рядки:
```
alias realdst => realdst
alias remoteip => remoteip
alias start => calldate
alias назва_стовпця => назва_стовпця
```

Замість "назва_стовпця" вставте назву стовпця, в якому зберігається назва запису дзвінка, наприклад "filename".
Аліас "remoteip" потрібен для запису IP адреси клієнта Asterisk. Це НЕОБОВ'ЯЗКОВО.

Створення аліасу `alias start => calldate` і наявність у базі колонки "calldate" обов'язково для правильної роботи CDR Viewer.

Усі зміни проводимо в `extensions.ael`, або в `extensions.conf`. Залежно від того, в якому файлі у нас написаний діалплан.

### Для extensions.ael, extensions.conf

В "globals" додамо пару змінних:
```
// Якщо 0, запис розмов вимкнено
// Якщо 1, запис розмов увімкнено з одночасною конвертацією в MP3
// Якщо 2, запис розмов увімкнено і виконується запис у формат WAV. Перетворення в MP3 формат має бути виконано скриптом "proc_records.sh"
RECORDING=1;
// Шлях до папки із записами розмов
DIR_RECORDS=/home/calls/;
```

Додамо макрос.

Одразу уточнимо, що в цьому макросі, якщо **RECORDING=1**, запис прямо під час розмови конвертується в MP3, тобто існує деяке навантаження на сервер.

Якщо ж **RECORDING=2**, то навантаження на сервер мінімальне, оскільки запис виконується в рідний формат Asterisk - WAV. Конвертування в MP3 має бути виконано 
за допомогою скрипта `proc_records.sh`, який можна знайти в папці docs. У скрипті написані докладні коментарі щодо його налаштування

### Для extensions.ael

```
// MixMonitor
macro recording(calling,called) {
	if ("${RECORDING}" = "1") {
		Set(fname=${UNIQUEID}-${STRFTIME(${EPOCH},,%Y-%m-%d-%H_%M)}-${calling}-${called});
		Set(monopt=nice -n 19 /usr/bin/lame -b 32  --silent "${DIR_RECORDS}${fname}.wav"  "${DIR_RECORDS}${fname}.mp3" && rm -f "${DIR_RECORDS}${fname}.wav" && chmod o+r "${DIR_RECORDS}${fname}.mp3");
		Set(CDR(filename)=${fname}.mp3);
		Set(CDR(realdst)=${called});
		Set(CDR(remoteip)=${CHANNEL(recvip)});
		MixMonitor(${DIR_RECORDS}${fname}.wav,b,${monopt});
   } else if ("${RECORDING}" = "2") {
 		Set(fname=${UNIQUEID}-${STRFTIME(${EPOCH},,%Y-%m-%d-%H_%M)}-${calling}-${called});
		Set(CDR(filename)=${fname}.wav);
		Set(CDR(realdst)=${called});
		Set(CDR(remoteip)=${CHANNEL(recvip)});
		MixMonitor(${DIR_RECORDS}${fname}.wav,b);  
   }
   return;
};
```

### Для extensions.conf

```
; MixMonitor
[macro-recording]
exten => s,1,GoToIf($["${RECORDING}" = "1"]?mp3)
exten => s,n,GoToIf($["${RECORDING}" = "2"]?wav:no)
exten => s,n(mp3),Set(fname=${UNIQUEID}-${STRFTIME(${EPOCH},,%Y-%m-%d-%H_%M)}-${ARG1}-${ARG2});
exten => s,n,Set(monopt=nice -n 19 /usr/bin/lame -b 32  --silent "${DIR_RECORDS}${fname}.wav"  "${DIR_RECORDS}${fname}.mp3" && rm -f "${DIR_RECORDS}${fname}.wav" && chmod o+r "${DIR_RECORDS}${fname}.mp3");
exten => s,n,Set(CDR(filename)=${fname}.mp3);
exten => s,n,Set(CDR(realdst)=${ARG2});
exten => s,n,Set(CDR(remoteip)=${CHANNEL(recvip)});
exten => s,n,MixMonitor(${DIR_RECORDS}${fname}.wav,b,${monopt});
exten => s,n,Goto(no);
exten => s,n(wav),Set(fname=${UNIQUEID}-${STRFTIME(${EPOCH},,%Y-%m-%d-%H_%M)}-${ARG1}-${ARG2});
exten => s,n,Set(CDR(filename)=${fname}.wav);
exten => s,n,Set(CDR(realdst)=${ARG2});
exten => s,n,Set(CDR(remoteip)=${CHANNEL(recvip)});
exten => s,n,MixMonitor(${DIR_RECORDS}${fname}.wav,b);
exten => s,n,Goto(no);
exten => s,n(no),Verbose(Exit record);
```

#### Приклад виклику макроса:

```
[internal]
exten => _X.,1,Macro(recording,${CALLERID(num)},${EXTEN})
exten => _X.,n,Dial(SIP/${EXTEN},60)
exten => _X.,n,Hangup()
```

## Налаштування папки з дзвінками

Записи розмов складатимуться в папку `/home/calls/` з прикладу вище.

Є два варіанти зберігання файлів записів:

1. Усі записи розмов зберігаються в одній папці.
2. Записи розмов повинні розподілятися по папках відповідно до дати.

**Також є можливість налаштування "відкладеної конвертації записів розмов"."**.

Коли вдень виконується запис у формат WAV, а вночі необхідно по CRON запустити скрипт для перетворення файлів з WAV в MP3.
"Відкладену конвертацію записів розмов" і розподіл по папках відповідно до дати можна використовувати разом, а можна щось одне..

За розподіл файлів записів по папках, перетворення файлів з WAV в MP3 відповідає скрипт `proc_records.sh` з папки docs.

### Для 2 варіанта

Щодня о 00.01 годині записи з папки `/home/calls/` за CRON повинні розподілятися за датою у відповідні папки.

Для розподілу файлів по папках відповідно до дати потрібно використовувати скрипт `proc_records.sh` з папки docs.

Формат зберігання записів (приклад):

1. /home/calls/2014/2014-09/2014-09-29
2. /home/calls/2014/09/29

#### Налаштування скрипта `proc_records.sh` для відповідного формату:

1.
```
DIR_DST="/home/calls/$Y/$YM/$YMD/"
MOVE_BY_DATE=true
```

2.
```
DIR_DST="/home/calls/$Y/$M/$D/"
MOVE_BY_DATE=true
```

#### Налаштування скрипта `proc_records.sh` для перетворення файлів з WAV в MP3:

За увімкнення перетворення файлів із WAV у MP3 у скрипті відповідає змінна `CONV_TO_MP3`. Необхідно встановити її значення в **true** або **false**.

Можна налаштувати МІНІМАЛЬНИЙ РОЗМІР ФАЙЛА для перетворення файлів з WAV в MP3, задається в змінній `REMOVE_MIN_SIZE`, розмір вказується в Кілобайтах.
Якщо розмір файлу менший за `REMOVE_MIN_SIZE`, то цей файл буде видалено, і його не буде перетворено з WAV в MP3.

Також можна налаштувати рівень вкладеності пошуку WAV-файлів для їх перетворення у змінній "DEPTH".

Приклади значень для змінної
```
1 - це всі файли в папці /home/calls/
2 - це всі файли в /home/calls/, /home/calls/2017/ ...
3 - це всі файли в /home/calls/, /home/calls/2017/, /home/calls/2017/04 ...
...
```

### Для варіантів, коли Asterisk сам розподіляє записи по папках відповідно до дати.

Якщо у вас Asterisk сам розподіляє записи дзвінків по папках відповідно до дати, тоді необхідності запуску скрипта по CRON немає.
Якщо тільки у вас не налаштована "відкладена конвертація записів розмов"

#### Можливі формати зберігання записів:

1. /home/calls/2014/2014-09/2014-09-29
2. /home/calls/2014/09/29

### Повний/Частковий шлях до файлів дзвінків зберігається в базі даних

Якщо у вас повний або частковий шлях до файлів дзвінків зберігається в базі даних, припустимо, в стовпці "column_name".
Наприклад: `./calls/2015/2015-01/2015-01-01/in/filename.mp3`, `2015/2015-01/2015-01-01/in/filename.mp3`, `/home/calls/2015/2015-01/2015-01-01/in/filename.mp3`.

У цьому випадку можна використовувати як повний шлях до файлу, так і частковий. Також у шляху можна використовувати ім'я файлу як із розширенням, так і без розширення файлу.

Якщо у вас використовується повний шлях до файлу (від кореня диска), то в конфіг-файлі необхідно задати: `'monitor_dir' => ''`.

Якщо у вас використовується частковий шлях до файлу, припустимо `2015/2015-01/2015-01-01-01/in/filename.mp3`, то в конфіг-файлі необхідно задати першу частину шляху, наприклад: `'monitor_dir' => '/home/calls'`.
БЕЗ слеша в кінці. Таким чином отримаємо повний шлях: `/home/calls/2015/2015-01/2015-01-01/in/filename.mp3`.

Якщо у вас використовується відносний шлях до файлу, припустимо `./calls/2015/2015-01/2015-01-01-01/in/filename.mp3`, то в конфіг-файлі необхідно задати першу частину шляху, наприклад: `'monitor_dir' => '/home'`.
БЕЗ слеша в кінці. Таким чином отримаємо повний шлях: `/home/./calls/2015/2015-01/2015-01-01/in/filename.mp3`.

Аналогічно для файлів без розширення.

#### Приклади шляхів до файлів під час їх зберігання в базі даних (вміст колонки "filename"):
1. /home/calls/2015/2015-01/2015-01-01/in/filename.mp3
2. ./calls/2015/2015-01/2015-01-01/in/filename.mp3
3. 2015/2015-01/2015-01-01/in/filename.mp3
4. /home/calls/2015/2015-01/2015-01-01/in/filename
5. ./calls/2015/2015-01/2015-01-01/in/filename
6. 2015/2015-01/2015-01-01/in/filename

## Видалення старих записів дзвінків

Для видалення старих записів дзвінків потрібно використовувати скрипт `proc_records.sh` з папки docs. У ньому є докладні коментарі з налаштування.

Можна видаляти тільки старі записи дзвінків, але залишатимуться порожні папки. Можна увімкнути видалення порожніх папок, тоді всі порожні папки в директорії,
яка задана в `DIR_SOURCE`, а також з усіх вкладених у неї папок будуть видалені.

Щоб увімкнути видалення старих записів дзвінків, у скрипті слід задати:
```
CLEAN_OLD=true
```

У змінній `CLEAN_OLD_AFTER` задається кількість днів зберігання файлів записів дзвінків. Наприклад: Якщо задано `CLEAN_OLD_AFTER=365`, то всі файли, старші **365** днів, будуть видалені.
Береться час зміни файлу, розширення файлу при видаленні НЕ враховується. Тобто якщо в папці, наприклад, є "*.txt" файл старше цього терміну, він також буде видалений.

У змінній `CLEAN_OLD_MIN_SIZE` задається мінімальний розмір файлів зберігання записів дзвінків. Якщо розмір файлу менший за це значення, то його буде видалено. Розмір задається в кілобайтах.
Якщо задано `CLEAN_OLD_MIN_SIZE=0`, то цю функцію вимкнено. Наприклад: Якщо задано `CLEAN_OLD_MIN_SIZE=30`, то файли, розмір яких менший за 30 КБ, будуть видалені.

У змінній `CLEAN_OLD_EMPTYDIR` можна ввімкнути видалення порожніх папок. Щоб це увімкнути, у скрипті слід задати:
```
CLEAN_OLD_EMPTYDIR=true
```

## Налаштування CDR Viewer

Приклад конфіг файлу знаходиться в `inc/config/config.php.sample`.

**Перед початком використання цей файл потрібно перейменувати в `config.php`**.

Усі налаштування знаходяться у файлі `inc/config/config.php` з докладними коментарями, тут не повинно виникнути складнощів.


### Створення .htpasswd файла
```
htpasswd -c /path/to/.htpasswd admin
```

### Приклад конфіга для Nginx:
```
location /path/to/script {
	auth_basic "CDR ITPower Mod";
	auth_basic_user_file /path/to/.htpasswd;
}
```

### Приклад конфіга для Apache:
```
<Location "/path/to/script">
	AuthName "CDR ITPower Mod"
	AuthType Basic
	AuthUserFile /path/to/.htpasswd
	require valid-user
</Location>
```

6. Прописати в конфігурації скрипта імена користувачів у вигляді масиву, яким дозволено доступ
```
'admins' => array(
	'admin1',
	'admin2',
	'admin3',
),
```

#### Якщо масив порожній, то дозволено доступ усім користувачам
```
'admins' => array(

),
```

## Вибір режиму роботи сервера телефонної платформи

У конфіг-файлі файлі можна вибрати режим роботи сервера телефонної платформи (Asterisk або FreeSWITCH). Це потрібно для вибіркового відображення функціональності, яка підтримується конкретним видом сервера телефонії.

Наприклад, якщо вибрано Asterisk: У фільтрі пошуку "Статус дзвінка" будуть показані значення тільки для Asterisk, але будуть приховані значення для "FreeSWITCH".
Якщо обрано режим "Asterisk + FreeSWITCH", то у фільтрі пошуку "Статус дзвінка" будуть показані значення і для Asterisk, і для FreeSWITCH.

Вибрати режим "Asterisk + FreeSWITCH": `'server_mode' => 0`

Вибрати режим "Asterisk": `'server_mode' => 1`

Вибрати режим "FreeSWITCH": `'server_mode' => 2`

## Налаштування тарифів на дзвінки

Тарифи на дзвінки задаються у файлі **my_callrates.csv** (`inc/plugins/my_callrates.csv`). Шлях до цього файлу можна змінити в конфігурації.

### Формат завдання тарифи в CSV файлі:
```
Код_регіону,вартість_хвилини[,Напрямок,Тип_тарифікації,Доп_тариф]
```

*Те, що у фігурних дужках - необов'язково*.

### Типи тарифікації:
```
s		- посекундно (немає доп. тарифу)
m       - похвилинно (є доп. тариф)
c       - за весь дзвінок (немає дод. тарифу)
1m+s    - посекундно з 2 хвилини (є доп. тариф)
30s+s   - посекундно після 30 секунди
30s+6s  - округлення інтервалами до 6 сек. після закінчення перших 30 сек. розмови (Skype Connect)
```

### Підтримка плагінів

Функціональність CDR ITPower можна розширювати за допомогою плагінів.

- Ім'я файлу плагіна повинно мати такий формат: `[ім'я_плагіна].php` (наприклад: `my_plugin.php`)
- Плагін повинен містити в собі функцію `[ім'я_плагіна]` (наприклад: `my_plugin`)
- Файли плагінів повинні розташовуватися в папці `inc/plugins`

#### Додавання нового плагіна

- Скопіювати файл плагіна в папку `inc/plugins`.
- У конфіг-файлі (наприклад: `inc/config/config.php`) додати завантаження плагіна. Для цього в масив **plugins** додати нове значення (див. коментарі в конфіг-файлі)

Як приклад для створення нового плагіна, можна використовувати плагін `inc/plugins/my_callrates.php`

### Робота з БД PostgreSQL

Для використання CDR Viewer з базою даних PostgreSQL, у базу необхідно додати таку функцію:
```
CREATE FUNCTION unix_timestamp(TIMESTAMP) RETURNS INTEGER AS '
SELECT date_part(''epoch'', $1)::INTEGER AS RESULT
' LANGUAGE sql;
CREATE FUNCTION
```
	
## Використання CDR Viewer

### Регулярні вирази

У фільтрах пошуку: "Хто дзвонив", "Куди дзвонили", "DID (якщо є)" можна використовувати регулярні вирази Asterisk.

Якщо значення в одному з цих полів починається на символ `_`, то це інтерпретується як шаблон пошуку.

У шаблонах пошуку деякі символи мають такі значення:

- **X** - будь-яка цифра від 0 до 9
- **Z** - будь-яка цифра від 1 до 9
- **N** - будь-яка цифра від 2 до 9
- **[1235-9]** - будь-яка цифра в дужках (у цьому прикладі: 1,2,3,5,6,7,8,9)
- **.** - відповідає будь-якому символу.








